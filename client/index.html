<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="JustCode - Real-time code editor, AI helper, and collaboration platform for students and developers." />
    <meta name="theme-color" content="#ff6600" />

    <link href="./src/output.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Poppins:wght@400;600&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet" />

    <title>JustCode</title>

    <style>
      /* Prevent white flash and show minimal loader until React mounts */
      html, body {
        background: #0d1117; /* matches dark theme */
        min-height: 100%;
      }
      #app-preloader {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: #0d1117;
        z-index: 9999;
      }
      
      /* New loader animation - more visible */
      .loader-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      
      .loader-text {
        color: #7c3aed;
        font-family: 'Poppins', sans-serif;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
      }
      
      .loader-pulse {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }
      
      .loader-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #7c3aed;
        animation: pulse 1.5s ease-in-out infinite;
      }
      
      .loader-dot:nth-child(1) {
        animation-delay: 0s;
      }
      
      .loader-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .loader-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.7;
          background-color: #7c3aed;
        }
        50% {
          transform: scale(1.5);
          opacity: 1;
          background-color: #8b5cf6;
          box-shadow: 0 0 15px #8b5cf6;
        }
      }
      
      /* Add a simple progress bar that lasts for 6 seconds */
      .loader-progress {
        width: 200px;
        height: 4px;
        background: rgba(124, 58, 237, 0.2);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 15px;
      }
      
      .loader-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #7c3aed, #8b5cf6);
        border-radius: 2px;
        animation: progress 6s linear forwards;
      }
      
      @keyframes progress {
        0% { width: 0%; }
        100% { width: 100%; }
      }
    </style>

    <script type="text/javascript">
      (function(d, t) {
          var v = d.createElement(t), s = d.getElementsByTagName(t)[0];

          v.onload = function() {
            // Initialize Voiceflow chat when on editor page or if we're navigating to it
            function initVoiceflow() {
              // Use a more robust approach to check if we're on the editor page
              // Consider the URL after potential redirects or routing
              const isEditorPage = () => {
                // Check current path
                const path = window.location.pathname;
                return path === '/editor' || path === '/editor/';
              };
              
              if (isEditorPage()) {
                // Check if the chat is already loaded to avoid duplicates
                if (window.voiceflow && window.voiceflow.chat && !window.voiceflow.chat.isLoaded) {
                  window.voiceflow.chat.load({
                    verify: { projectID: '695a95066f20de2ac229a353' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    voice: {
                      url: "https://runtime-api.voiceflow.com"
                    }
                  });
                  
                  // Mark as loaded to prevent re-initialization
                  window.voiceflow.chat.isLoaded = true;
                }
              } else {
                // If we're not on the editor page, reset the loaded flag
                if (window.voiceflow && window.voiceflow.chat) {
                  window.voiceflow.chat.isLoaded = false;
                }
              }
            }
            
            // Initialize after a delay to ensure React app has loaded
            setTimeout(initVoiceflow, 500);
            
            // Also check for route changes (for SPA navigation)
            const originalPushState = history.pushState;
            history.pushState = function() {
                originalPushState.apply(history, arguments);
                setTimeout(initVoiceflow, 300);
            };
            
            // Listen for popstate events (browser back/forward)
            window.addEventListener('popstate', function() {
              setTimeout(initVoiceflow, 300);
            });
            
            // Listen for hash changes (another way routes can change)
            window.addEventListener('hashchange', function() {
              setTimeout(initVoiceflow, 300);
            });
            
            // Listen for page visibility changes which can occur on refresh
            document.addEventListener('visibilitychange', function() {
              if (!document.hidden) {
                // Page is visible again (after refresh or tab switch)
                setTimeout(initVoiceflow, 500);
              }
            });
            
            // Listen for focus events
            window.addEventListener('focus', function() {
              setTimeout(initVoiceflow, 300);
            });
            
            // Force loader to stay for at least 5-6 seconds
            setTimeout(function() {
              const preloader = document.getElementById('app-preloader');
              if (preloader && preloader.style.display !== 'none') {
                // Add a transition before hiding
                preloader.style.opacity = '0';
                preloader.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                  preloader.style.display = 'none';
                }, 500);
              }
            }, 6000); // Show for 6 seconds minimum
          }
          
          v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; v.type = "text/javascript"; s.parentNode.insertBefore(v, s);
      })(document, 'script');
    </script>
  </head>
  <body>
    <div id="app-preloader">
      <div class="loader-container">
        <div class="loader-text">Loading JustCode...</div>
        <div class="loader-pulse">
          <div class="loader-dot"></div>
          <div class="loader-dot"></div>
          <div class="loader-dot"></div>
        </div>
        <div class="loader-progress">
          <div class="loader-progress-bar"></div>
        </div>
      </div>
    </div>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>